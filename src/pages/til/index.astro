---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

const allTils = (await getCollection("til"))
    .filter((til) => !til.data.draft)
    .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// Build tag counts
const tagCounts = new Map<string, number>();
allTils.forEach((til) => {
    til.data.tags.forEach((tag) => {
        tagCounts.set(tag, (tagCounts.get(tag) || 0) + 1);
    });
});

// Sort tags alphabetically
const sortedTags = Array.from(tagCounts.entries()).sort((a, b) =>
    a[0].localeCompare(b[0]),
);

// Format date as dd-mm-yyyy
function formatDate(date: Date): string {
    const day = String(date.getDate()).padStart(2, "0");
    const month = String(date.getMonth() + 1).padStart(2, "0");
    const year = date.getFullYear();
    return `${day}-${month}-${year}`;
}
---

<BaseLayout
    title="TIL - Things I've Learned"
    description="Quick notes and learnings"
    withSidebar={false}
>
    <div class="til-page">
        <header class="til-header">
            <a
                href={import.meta.env.BASE_URL + "til/rss.xml"}
                class="rss-icon"
                title="Atom feed"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="currentColor"
                >
                    <circle cx="6.18" cy="17.82" r="2.18"></circle>
                    <path
                        d="M4 4.44v2.83c7.03 0 12.73 5.7 12.73 12.73h2.83c0-8.59-6.97-15.56-15.56-15.56zm0 5.66v2.83c3.9 0 7.07 3.17 7.07 7.07h2.83c0-5.47-4.43-9.9-9.9-9.9z"
                    ></path>
                </svg>
            </a>
            <span class="til-intro">
                Quick notes about things I've learned. You may also enjoy <a
                    href={import.meta.env.BASE_URL}>my blog</a
                >.
            </span>
        </header>

        <div class="til-layout">
            <section class="til-list">
                {
                    allTils.map((til) => (
                        <article class="til-entry">
                            <a
                                href={`${import.meta.env.BASE_URL}til/${til.slug}/`}
                                class="til-title"
                            >
                                {til.data.title}
                            </a>
                            <div class="til-meta">
                                <span class="til-date">
                                    {formatDate(til.data.pubDate)}
                                </span>
                                <span class="til-separator">·</span>
                                <a
                                    href={`${import.meta.env.BASE_URL}til/tags/${til.data.tags[0]}/`}
                                    class="tag-inline"
                                >
                                    {til.data.tags[0]}
                                </a>
                                <span class="til-separator">·</span>
                                <span class="til-excerpt">
                                    {til.data.description}
                                </span>
                            </div>
                        </article>
                    ))
                }
            </section>

            <aside class="browse-topics">
                <h2>Browse by topic</h2>
                <div class="tag-cloud">
                    {
                        sortedTags.map(([tag, count]) => (
                            <a
                                href={`${import.meta.env.BASE_URL}til/tags/${tag}/`}
                                class="tag-link"
                            >
                                {tag} <span class="count">{count}</span>
                            </a>
                        ))
                    }
                </div>
            </aside>
        </div>
    </div>
</BaseLayout>

<style>
    .til-page {
        max-width: 1000px;
    }

    .til-header {
        display: flex;
        align-items: center;
        gap: 0.6rem;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--color-border);
    }

    .rss-icon {
        color: #f26522;
        display: flex;
        align-items: center;
        flex-shrink: 0;
    }

    .rss-icon:hover {
        opacity: 0.8;
    }

    .til-intro {
        color: var(--color-text-light);
        font-size: 0.95rem;
    }

    .til-intro a {
        color: var(--color-primary);
    }

    /* Two-column layout */
    .til-layout {
        display: grid;
        grid-template-columns: 1fr 220px;
        gap: 2rem;
        align-items: start;
    }

    /* TIL entries */
    .til-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .til-entry {
        padding-bottom: 0.75rem;
        border-bottom: 1px solid #eee;
    }

    .til-entry:last-child {
        border-bottom: none;
    }

    .til-title {
        display: block;
        color: var(--color-text);
        text-decoration: none;
        font-weight: 600;
        font-size: 1rem;
        margin-bottom: 0.2rem;
    }

    .til-title:hover {
        color: var(--color-primary);
    }

    .til-meta {
        font-size: 0.85rem;
        color: var(--color-text-light);
    }

    .til-date {
        font-family: monospace;
        font-size: 0.8rem;
    }

    .til-separator {
        margin: 0 0.4rem;
    }

    .tag-inline {
        color: var(--color-primary);
        text-decoration: none;
        font-weight: 500;
    }

    .tag-inline:hover {
        text-decoration: underline;
    }

    /* Sidebar */
    .browse-topics {
        background: var(--color-bg-light, #f9f9f9);
        padding: 1rem;
        border-radius: 8px;
        position: sticky;
        top: 1rem;
    }

    .browse-topics h2 {
        font-size: 0.9rem;
        font-weight: 600;
        margin-bottom: 0.75rem;
        color: var(--color-text);
    }

    .tag-cloud {
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
    }

    .tag-link {
        color: var(--color-primary);
        text-decoration: none;
        font-size: 0.85rem;
    }

    .tag-link:hover {
        text-decoration: underline;
    }

    .tag-link .count {
        color: var(--color-text-light);
        font-size: 0.75rem;
    }

    /* Mobile: stack layout, topics at bottom */
    @media (max-width: 768px) {
        .til-header {
            margin-bottom: 0.5rem;
            padding-bottom: 0.5rem;
        }

        .til-layout {
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .browse-topics {
            order: 2;
            position: static;
            padding: 0.75rem;
        }

        .til-list {
            order: 1;
            gap: 1px;
        }

        .til-entry {
            padding: 0.5rem 0;
            margin-bottom: 0;
            border-bottom: 1px solid #eee;
        }

        .til-title {
            font-size: 1rem;
            text-transform: uppercase;
        }

        .til-meta {
            font-size: 0.75rem;
        }
    }
</style>
