---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

const allTils = (await getCollection("til"))
    .filter((til) => !til.data.draft)
    .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// Build tag counts
const tagCounts = new Map<string, number>();
allTils.forEach((til) => {
    til.data.tags.forEach((tag) => {
        tagCounts.set(tag, (tagCounts.get(tag) || 0) + 1);
    });
});

// Sort tags alphabetically
const sortedTags = Array.from(tagCounts.entries()).sort((a, b) =>
    a[0].localeCompare(b[0]),
);
---

<BaseLayout
    title="TIL - Things I've Learned"
    description="Quick notes and learnings"
    withSidebar={false}
>
    <div class="til-page">
        <header class="til-header">
            <h1>TIL (Today I Learned)</h1>
            <p class="til-intro">
                Quick notes about things I've learned. You may also enjoy <a
                    href={import.meta.env.BASE_URL}>my blog</a
                >.
            </p>
            <p class="feed-link">
                <a href={import.meta.env.BASE_URL + "til/rss.xml"}>
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="14"
                        height="14"
                        viewBox="0 0 24 24"
                        fill="currentColor"
                    >
                        <circle cx="6.18" cy="17.82" r="2.18"></circle>
                        <path
                            d="M4 4.44v2.83c7.03 0 12.73 5.7 12.73 12.73h2.83c0-8.59-6.97-15.56-15.56-15.56zm0 5.66v2.83c3.9 0 7.07 3.17 7.07 7.07h2.83c0-5.47-4.43-9.9-9.9-9.9z"
                        ></path>
                    </svg>
                    Atom feed
                </a>
            </p>
        </header>

        <section class="browse-topics">
            <h2>Browse by topic:</h2>
            <div class="tag-cloud">
                {
                    sortedTags.map(([tag, count]) => (
                        <a
                            href={`${import.meta.env.BASE_URL}til/tags/${tag}/`}
                            class="tag-link"
                        >
                            {tag} <span class="count">{count}</span>
                        </a>
                    ))
                }
            </div>
        </section>

        <section class="recent-tils">
            <h2>Recent TILs</h2>
            <div class="til-list">
                {
                    allTils.map((til) => (
                        <article class="til-entry">
                            <div class="til-tags">
                                {til.data.tags.map((tag) => (
                                    <a
                                        href={`${import.meta.env.BASE_URL}til/tags/${tag}/`}
                                        class="tag-badge"
                                    >
                                        {tag}
                                    </a>
                                ))}
                            </div>
                            <h3>
                                <a
                                    href={`${import.meta.env.BASE_URL}til/${til.slug}/`}
                                >
                                    {til.data.title}
                                </a>
                                <span class="til-date">
                                    -{" "}
                                    {til.data.pubDate.toLocaleDateString(
                                        "en-us",
                                        {
                                            year: "numeric",
                                            month: "short",
                                            day: "numeric",
                                        },
                                    )}
                                </span>
                            </h3>
                            <p class="til-excerpt">{til.data.description}</p>
                        </article>
                    ))
                }
            </div>
        </section>
    </div>
</BaseLayout>

<style>
    .til-page {
        max-width: 800px;
    }

    .til-header {
        margin-bottom: 2rem;
    }

    .til-header h1 {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
    }

    .til-intro {
        color: var(--color-text-light);
        margin-bottom: 0.5rem;
    }

    .feed-link a {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        color: var(--color-primary);
        font-size: 0.9rem;
    }

    .feed-link svg {
        color: #f26522;
    }

    .browse-topics {
        margin-bottom: 2.5rem;
        padding-bottom: 2rem;
        border-bottom: 1px solid var(--color-border);
    }

    .browse-topics h2 {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 0.75rem;
        color: var(--color-text);
    }

    .tag-cloud {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        line-height: 1.8;
    }

    .tag-link {
        color: var(--color-primary);
        text-decoration: none;
        font-size: 0.9rem;
    }

    .tag-link:hover {
        text-decoration: underline;
    }

    .tag-link .count {
        color: var(--color-text-light);
        font-size: 0.8rem;
    }

    .tag-link::after {
        content: " Â· ";
        color: var(--color-text-light);
    }

    .tag-link:last-child::after {
        content: "";
    }

    .recent-tils h2 {
        font-size: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .til-entry {
        margin-bottom: 1.5rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid #eee;
    }

    .til-entry:last-child {
        border-bottom: none;
    }

    .til-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem;
        margin-bottom: 0.5rem;
    }

    .tag-badge {
        background: var(--color-secondary);
        color: #fff;
        padding: 0.15rem 0.5rem;
        border-radius: 3px;
        font-size: 0.75rem;
        text-decoration: none;
        font-weight: 500;
    }

    .tag-badge:hover {
        background: #444;
        color: #fff;
        text-decoration: none;
    }

    .til-entry h3 {
        font-size: 1.1rem;
        margin: 0 0 0.5rem 0;
        font-weight: 600;
    }

    .til-entry h3 a {
        color: var(--color-text);
        text-decoration: none;
    }

    .til-entry h3 a:hover {
        color: var(--color-primary);
    }

    .til-date {
        color: var(--color-text-light);
        font-weight: 400;
        font-size: 0.9rem;
    }

    .til-excerpt {
        color: var(--color-text-light);
        font-size: 0.95rem;
        margin: 0;
        line-height: 1.5;
    }

    @media (max-width: 600px) {
        .til-header h1 {
            font-size: 2rem;
        }
    }
</style>
